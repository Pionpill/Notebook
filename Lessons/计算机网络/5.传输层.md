<link href="style.css" rel="stylesheet" type="text/css"/>  

<h1> 5 传输层 </h1>

<h2> 5.1 传输层概念 </h2>
<h3> 5.1.1 传输层的基本概念 </h3>

> 传输层的功能，传输层的两个协议，传输层的寻址与端口

<h4> 传输层的功能 </h4>

  - 传输层提供进程和进程之间的逻辑通信
    - 网络层提供主机之间的逻辑通信
  - 复用和分用
  - 传输层对收到的报文进行差错检测

<h4> 传输层的两个协议 </h4>

  - <span class=ptc>TCP</span>：面向连接的传输控制协议
    - 内容：必须建立连接，开销大
    - 特点：可靠，面向连接，时延大，适用于大文件
  - <span class=ptc>UDP</span>：无连接的用户数据报协议
    - 内容：不需要连接，不需要确认
    - 特点：不可靠，无连接，时延小，适用于小支件

<h4> 传输层的寻址与端口 </h4>

  - 复用：应用层所有的应用进程都可以通过传输层再传输到网络层
  - 分用：传输层从网络层收到数据后交付指明的应用进程
  - 端口：逻辑端口/软件端口
    - 是传输层的SAP,标识主机中的应用进程
    - 端口号：长度为16bit,能表示65536个不同的端口号
      - 服务端使用
        - 熟知端口号 (0-1023)：给TCP/P最重要的一些应用程序，让所有用户都知道
        - 登记端口号 (1024-49151)：为没有熟知端口号的应用程序使用的
      - 客户使用 (49152~65535)
        - 仅在客户进程运行时才动态选择
  - 套接字 Socket
    - Socket = (主机IP地址，端口号)
    - 套接字唯一标识了网络中的一个主机和它上面的一个进程

<h2> 5.2 UDP </h2>

<h3> 5.2.1 UDP 概述 </h3>

> UDP 功能，UDP主要特点，UDP校验

<h4> UDP 功能 </h4>

  - UDP只在P数据报服务之上增加了很少功能，即复用分用和差错检测功能

<h4> UDP 主要特点 </h4>

  - UDP是无连接的，减少开销和发送数据之前的时延
  - UDP使用最大努力交付，即不保证可靠交付
  - UDP是面向报文的，适合一次性传输少量数据的网络应用
    - 保留报文，不进行拆分等处理
  - UDP无拥塞控制，适合很多实时应用
  - UDP首部开销小，8B,TCP20B
  
<h4> UDP 首部格式 </h4>

  - 图示  
    <img src=images/png/UDP首部格式.png width=400px>
    - 源端口号：可有可无

<h4> UDP 校验 </h4>

  - 图示  
    <img src=images/png/UDP校验.png width=400px>
    - 伪首部只有在计算检验和时才出现，不向下传送也不向上递交。

<h2> 5.3 TCP </h2>

<h3> 5.3.1 TCP 特点及报文格式 </h3>

> TCP 特点，TCP 首部格式

<h4> TCP 特点 </h4>

  - TCP是面向连接（虚连接）的传输层协议
  - 每一条TCP连接只能有两个端点，每一条TCP连接只能是点对点的
  - TCP提供可靠交付的服务，无差错、不丢失、不重复、按序到达。可靠有序，不丢不重
  - TCP 提供全双工通信
    - 发送缓存：准备发送的数据&己发送但尚未收到确认的数据
    - 接收缓存：按序到达但尚未被接受应用程序读取的数据&不按序到达的数据
  - TCP 面向字节流
    - CP把应用程序交下来的数据看成仅仅是一连串的无结构的字节流

<h4> TCP 首部格式 </h4>

  - 图示  
    <img src=images/png/TCP首部格式.png width=400px>
    - 序号：在一个TCP连接中传送的字节流中的每一个字节都按顺序编号，本字段表示本报文段所发送数据的第一个字节的序号。
    - 确认号：期望收到对方下一个报文段的第一个数据字节的序号。若确认号为N,则证明到序号N-1为止的所有数据都己正确收到。
    - 数据偏移（首部长度）：TCP报文段的数据起始处距离TCP报文段的起始处有多远，以4B位单位，即1个数值是4B
    - 控制位
      - URG：紧急位：拥有最该优先级，尽快发送
      - ACK：确认位：确认后才有效，连接后必须置为1
      - PSH：推送位：尽快交付上层
      - PST：复位：出现严重差错，必须释放连接，重新建立
      - SYN：同步位：表明是一个连接请求/接收报文
      - FIN：终止位：报文发送完，终止连接
    - 窗口：指的是发送本报文段的一方的接收窗口，即现在允许对方发送的数据量。
    - 检验和：检验首部+数据，检验时要加上12B伪首部，第四个字段为6。
    - 紧急指针：URG=1时才有意义，指出本报文段中紧急数据的字节数

<h3> 5.3.2 TCP 功能 </h3>

> TCP连接过程，TCP可靠传输，TCP流量控制

<h4> TCP 连接过程 </h4>

  - TCP连接传输三个阶段
    - 连接建立 &rarr; 数据传输 &rarr; 连接释放
  - TCP连接的建立采用客户服务器方式，主动发起连接建立的应用进程叫做客户，而被动等待连接建立的应用进程叫服务器
    <img src=images/png/TCP连接的建立.png width=550px>  
    <img src=images/png/TCP连接的释放.png width=550px>

<h4> TCP 可靠传输 </h4>

  - 可靠：保证接收方进程从缓存区读出的字节流与发送方发出的字节流是完全一样的
  - TCP 实现可靠传输的机制
    - 校验：添加伪首部
    - 序号：一个字节占一个序号
    - 确认：收到报文段后返回确认报文段
    - 重传：在重传时间内没有收到确认，再次传输
      - 重传时间：TCP采用自适应算法，动态改变重传时间RTTs
      - ACK (冗余确认)
        - 每当比期望序号大的失序报文段到达时，发送一个冗余ACK, 指明下一个期待字节的序号

<h4> TCP 流量控制 </h4>

  - TCP利用滑动窗口机制实现流量控制
  - 在通信过程中，接收方根据自己接收缓存的大小，动态地调整发送方的发送窗口大小，即接收窗口rwnd(接收方设置确认报文段的窗口字段来将rwnd通知给发送方），发送方的发送窗口取接收窗口rwnd和拥塞窗口cwnd的最小值

<h4> TCP 拥塞控制 </h4>

  - 出现拥塞的条件
    - 对资源需求的总和>可用资源
  - 拥塞控制
    - 防止过多的数据注入到网络中：全局
  - 慢开始和拥塞避免  
    <img src=images/png/满开始和拥塞避免.png width=550px>
    - 传输轮次
      - 发送了一批报文段并收到它们的确认的时间。
      - 一个往返时延RTT。  
  - 快重传和快恢复
    <img src=images/png/快重传和快恢复.png width=550px>